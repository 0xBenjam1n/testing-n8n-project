<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Profile Analyzer - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'instagram-pink': '#e1306c',
                        'instagram-purple': '#c13584'
                    },
                    animation: {
                        'spin': 'spin 1s linear infinite',
                        'shimmer': 'shimmer 2s infinite'
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { left: '-100%' },
                            '100%': { left: '100%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .shimmer-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body class="font-sans bg-gray-100 p-5">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg">
        <div class="bg-gradient-to-r from-instagram-pink to-instagram-purple text-white p-8 text-center rounded-t-lg">
            <h1 class="text-2xl font-bold mb-3">üì∏ Instagram Analyzer Demo</h1>
            <p>Simple Instagram profile analysis tool</p>
        </div>
        
        <div class="p-8">
            <div id="mainPage">
                <div class="mb-5">
                    <label for="usernameInput" class="block mb-2 font-bold">Instagram Username:</label>
                    <input type="text" id="usernameInput" 
                           class="w-full p-3 border-2 border-gray-300 rounded focus:outline-none focus:border-instagram-pink text-base" 
                           placeholder="Enter username (e.g., cristiano)" autocomplete="off">
                </div>
                
                <button class="w-full bg-instagram-pink text-white p-3 border-none rounded cursor-pointer text-base transition-colors hover:bg-instagram-purple disabled:bg-gray-400 disabled:cursor-not-allowed" 
                        id="analyzeBtn" onclick="startAnalysis()">üîç Analyze Profile</button>
                
                <div id="status" class="mt-4 p-3 rounded text-center text-sm font-medium hidden"></div>
                
                <div class="mt-8 pt-5 border-t-2 border-gray-100" id="resultsSection" style="display: none;">
                    <h2 class="text-xl mb-4 text-gray-700">üìä Analysis Results</h2>
                    <div id="dataDisplay"></div>
                </div>
            </div>

            <div id="selectionPage" class="hidden">
                <h2 class="text-xl mb-4 text-gray-700">üìã Content Selection</h2>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 my-5">
                    <p class="mb-5 text-gray-500 text-center">
                        Select what content you want to analyze:
                    </p>
                    
                    <div class="grid gap-4 my-5" id="selectionOptions">
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 flex items-center gap-3 transition-all cursor-pointer hover:bg-gray-100 hover:border-gray-300" 
                             onclick="toggleOption('posts')">
                            <input type="checkbox" id="postsCheck" class="w-5 h-5 cursor-pointer">
                            <div class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-700 mb-1">üì∏ Posts</div>
                                <div class="text-sm text-gray-500" id="postsCount">0 posts available</div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 flex items-center gap-3 transition-all cursor-pointer hover:bg-gray-100 hover:border-gray-300" 
                             onclick="toggleOption('highlights')">
                            <input type="checkbox" id="highlightsCheck" class="w-5 h-5 cursor-pointer">
                            <div class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-700 mb-1">‚ú® Highlights</div>
                                <div class="text-sm text-gray-500" id="highlightsCount">0 highlights available</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-3 mt-5">
                        <button class="px-5 py-2 bg-gray-500 text-white border-none rounded cursor-pointer text-sm hover:bg-gray-600" 
                                onclick="goBack()">‚Üê Back</button>
                        <button class="px-5 py-2 bg-green-600 text-white border-none rounded cursor-pointer text-sm hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" 
                                onclick="proceedWithSelection()" disabled>Proceed</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUsername = '', currentProfile = null;
        
        class UniversalImageLoader {
            static cache = new Map();
            
            static async loadImage(imageUrl, container) {
                if (!imageUrl) return this.showFallback(container);
                
                if (this.cache.has(imageUrl)) {
                    const result = this.cache.get(imageUrl);
                    return result.success ? this.showImage(container, result.url) : this.showFallback(container);
                }
                
                this.showLoading(container);
                
                try {
                    await this.loadDirectImage(imageUrl, container);
                } catch {
                    try {
                        await this.loadWithProxy(imageUrl, container);
                    } catch {
                        this.cache.set(imageUrl, { success: false });
                        this.showFallback(container);
                    }
                }
            }
            
            static loadDirectImage(imageUrl, container) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        this.cache.set(imageUrl, { success: true, url: imageUrl });
                        this.showImage(container, imageUrl);
                        resolve();
                    };
                    img.onerror = () => reject();
                    img.crossOrigin = 'anonymous';
                    img.src = imageUrl;
                    setTimeout(reject, 5000);
                });
            }
            
            static async loadWithProxy(imageUrl, container) {
                const proxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`,
                    `https://cors-anywhere.herokuapp.com/${imageUrl}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(imageUrl)}`,
                    imageUrl
                ];

                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy, { headers: { 'Accept': 'image/*' } });
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            this.cache.set(imageUrl, { success: true, url });
                            this.showImage(container, url);
                            return;
                        }
                    } catch { continue; }
                }
                throw new Error('All proxies failed');
            }
            
            static showLoading(container) {
                container.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            }
            
            static showImage(container, src) {
                container.innerHTML = `<img src="${src}" alt="Profile Picture" class="w-full h-full rounded-full border-3 border-white object-cover opacity-0 transition-opacity duration-300" crossorigin="anonymous" onload="this.style.opacity='1'" onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full rounded-full border-3 border-white bg-gray-600 flex items-center justify-center text-2xl text-white&quot;>üë§</div>'" style="opacity:0; transition: opacity 0.3s;">`;
            }
            
            static showFallback(container) {
                const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                container.innerHTML = `<div class="w-full h-full rounded-full border-3 border-white ${randomColor} flex items-center justify-center text-2xl text-white">üë§</div>`;
            }
        }
        
        // Enhanced username validation functions
        function isDataForCurrentUser(data) {
            if (!currentUsername || !data) return false;
            
            const currentUser = currentUsername.toLowerCase();
            console.log(`üîç Checking if data is for user: ${currentUser}`);
            
            // Check multiple possible username locations with exact matching
            const checks = [
                data.userInformation?.username?.toLowerCase(),
                data.username?.toLowerCase(),
                data.profile?.username?.toLowerCase()
            ];
            
            const match = checks.some(username => username === currentUser);
            console.log(`‚úÖ Username match result: ${match}`, checks);
            return match;
        }
        
        function isPostsDataForCurrentUser(data) {
            if (!currentUsername || !data) return false;
            
            const currentUser = currentUsername.toLowerCase();
            console.log(`üîç Checking if posts data is for user: ${currentUser}`);
            
            // For posts data, check if the username appears in the structure
            try {
                const dataStr = JSON.stringify(data).toLowerCase();
                const hasUsername = dataStr.includes(`"username":"${currentUser}"`);
                console.log(`‚úÖ Posts username match result: ${hasUsername}`);
                return hasUsername;
            } catch (error) {
                console.warn('Error checking posts data:', error);
                return false;
            }
        }
        
        function toggleOption(type) {
            const checkbox = document.getElementById(type + 'Check');
            const item = checkbox.closest('.bg-gray-50');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                item.classList.add('bg-red-50', 'border-instagram-pink');
                item.classList.remove('bg-gray-50', 'border-gray-200');
            } else {
                item.classList.remove('bg-red-50', 'border-instagram-pink');
                item.classList.add('bg-gray-50', 'border-gray-200');
            }
            
            updateProceedButton();
        }
        
        function updateProceedButton() {
            const posts = document.getElementById('postsCheck').checked;
            const highlights = document.getElementById('highlightsCheck').checked;
            document.querySelector('button[onclick="proceedWithSelection()"]').disabled = !posts && !highlights;
        }
        
        async function startAnalysis() {
            const input = document.getElementById('usernameInput');
            const button = document.getElementById('analyzeBtn');
            const username = input.value.trim();
            
            if (!username) return showStatus('Please enter an Instagram username', 'error');
            
            currentUsername = username;
            button.disabled = true;
            button.textContent = 'üîÑ Analyzing...';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('dataDisplay').innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-5 text-center">
                    <div class="w-6 h-6 border-3 border-gray-300 border-t-instagram-pink rounded-full animate-spin"></div>
                    <div class="text-base font-medium text-gray-700 mt-4">Analyzing @${username}</div>
                    <div class="text-sm text-gray-600 mt-2">Please wait while we fetch the profile data...</div>
                </div>`;
            
            try {
                console.log(`üöÄ Starting analysis for: ${username}`);
                
                const response = await fetch('https://oxbenjam1n.app.n8n.cloud/webhook-test/ee95c5d8-139e-4d35-8eab-b431b741f563', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ run_input: JSON.stringify({ usernames: [username] }) })
                });
                
                if (response.ok) {
                    input.value = '';
                    showStatus('Analysis started! Waiting for data...', 'success');
                    setTimeout(checkForResults, 3000);
                } else throw new Error(`HTTP error! status: ${response.status}`);
                
            } catch (error) {
                console.error('Network error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('resultsSection').style.display = 'none';
            } finally {
                button.disabled = false;
                button.textContent = 'üîç Analyze Profile';
            }
        }
        
        async function checkForResults(retryCount = 0) {
            if (retryCount > 20) {
                showStatus('Analysis timeout - no data received for this username', 'error');
                document.getElementById('dataDisplay').innerHTML = `
                    <div class="text-center py-10 text-red-600">
                        <h3 class="text-xl font-bold mb-3">‚è±Ô∏è Timeout</h3>
                        <p class="mb-4">No data received for @${currentUsername} after 20 attempts.</p>
                        <button onclick="resetApp()" class="bg-gray-500 text-white border-none py-2 px-5 rounded mt-4 cursor-pointer">üîÑ Try Again</button>
                    </div>
                `;
                return;
            }
            
            try {
                console.log(`üîÑ Checking for results (attempt ${retryCount + 1}/20) for: ${currentUsername}`);
                
                // Use username filtering to get only data for current user
                const response = await fetch(`https://testing-n8n-project-production.up.railway.app/api/received-data?username=${encodeURIComponent(currentUsername)}`);
                const data = await response.json();
                
                console.log(`üìä Received ${data.length} items for ${currentUsername}:`, data);
                
                // Find data specifically for current username with strict validation
                const userSpecificData = data.find(item => isDataForCurrentUser(item));
                
                if (userSpecificData && userSpecificData.userInformation) {
                    console.log(`‚úÖ Found valid data for ${currentUsername}`);
                    displayProfile(userSpecificData.userInformation);
                } else {
                    console.log(`‚è≥ No valid data yet for ${currentUsername}, retrying...`);
                    setTimeout(() => checkForResults(retryCount + 1), 3000);
                }
                
            } catch (error) {
                console.error('Error checking for results:', error);
                setTimeout(() => checkForResults(retryCount + 1), 5000);
            }
        }
        
        function displayProfile(profile) {
            currentProfile = profile;
            const format = (num) => (num || 0).toLocaleString();
            const badge = (val) => `<span class="inline-block px-2 py-1 text-xs font-bold rounded-full ${val ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${val ? 'Yes' : 'No'}</span>`;
            
            console.log(`üé® Displaying profile for: ${profile.username}`);
            
            document.getElementById('dataDisplay').innerHTML = `
                <div class="bg-gradient-to-br from-instagram-pink to-instagram-purple text-white p-8 rounded-xl mb-5 text-center">
                    <div class="w-25 h-25 mx-auto mb-5 rounded-full flex items-center justify-center" id="profilePicContainer" style="width: 100px; height: 100px;"></div>
                    <div class="text-2xl font-bold mb-2">${profile.fullName || 'No name provided'}</div>
                    <div class="text-base opacity-90 mb-5">@${profile.username}</div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-5">
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.followersCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block">Followers</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.followsCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block">Following</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.postsCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block">Posts</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${profile.verified ? '‚úÖ' : '‚ùå'}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block">Verified</span>
                        </div>
                    </div>
                    
                    ${profile.biography ? `<div class="bg-white bg-opacity-10 p-4 rounded-lg mt-4 leading-relaxed text-left"><strong>Bio:</strong><br>${profile.biography}</div>` : ''}
                </div>
                
                <div class="grid md:grid-cols-2 gap-5">
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <h3 class="mb-4 text-instagram-pink text-base font-semibold border-b-2 border-gray-100 pb-2">üìä Account Details</h3>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">Account Type:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${profile.isBusinessAccount ? 'Business' : 'Personal'}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">Private:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${badge(profile.private)}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">Verified:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${badge(profile.verified)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <h3 class="mb-4 text-instagram-pink text-base font-semibold border-b-2 border-gray-100 pb-2">üì∫ Content Stats</h3>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">Highlights:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${profile.highlightReelCount || 0}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">IGTV Videos:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${profile.igtvVideoCount || 0}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2 py-1">
                            <span class="font-bold text-gray-600">Has Channel:</span>
                            <span class="text-gray-700 text-right flex-1 ml-2">${badge(profile.hasChannel)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 my-6 text-center">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <input type="checkbox" id="ownershipCheck" class="w-5 h-5 cursor-pointer">
                        <label for="ownershipCheck" class="cursor-pointer font-medium text-gray-700 text-sm">Yes, this is my page</label>
                    </div>
                    <button class="bg-instagram-pink text-white py-3 px-6 border-none rounded-md cursor-pointer text-base font-semibold hover:bg-instagram-purple transition-colors" onclick="confirmOwnership()">Confirm</button>
                </div>`;
            
            UniversalImageLoader.loadImage(profile.profilePicUrlHD || profile.profilePicUrl, document.getElementById('profilePicContainer'));
            showStatus('Profile loaded successfully!', 'success');
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `mt-4 p-3 rounded text-center text-sm font-medium block ${type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-red-100 text-red-700 border border-red-300'}`;
            status.style.display = 'block';
            if (type === 'success') setTimeout(() => status.style.display = 'none', 5000);
        }
        
        function confirmOwnership() {
            if (!document.getElementById('ownershipCheck').checked) {
                return alert('Please check the confirmation box first!');
            }
            showSelectionPage();
        }

        function showSelectionPage() {
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('selectionPage').classList.remove('hidden');
            
            document.getElementById('postsCount').textContent = `${(currentProfile?.postsCount || 0).toLocaleString()} posts available`;
            document.getElementById('highlightsCount').textContent = `${(currentProfile?.highlightReelCount || 0).toLocaleString()} highlights available`;
            
            ['postsCheck', 'highlightsCheck'].forEach(id => document.getElementById(id).checked = false);
            document.querySelectorAll('#selectionOptions > div').forEach(item => {
                item.classList.remove('bg-red-50', 'border-instagram-pink');
                item.classList.add('bg-gray-50', 'border-gray-200');
            });
            updateProceedButton();
        }

        function goBack() {
            document.getElementById('selectionPage').classList.add('hidden');
            document.getElementById('mainPage').style.display = 'block';
            
            ['postsCheck', 'highlightsCheck'].forEach(id => document.getElementById(id).checked = false);
            document.querySelectorAll('#selectionOptions > div').forEach(item => {
                item.classList.remove('bg-red-50', 'border-instagram-pink');
                item.classList.add('bg-gray-50', 'border-gray-200');
            });
        }

        async function proceedWithSelection() {
            const posts = document.getElementById('postsCheck').checked;
            const highlights = document.getElementById('highlightsCheck').checked;
            const btn = document.querySelector('button[onclick="proceedWithSelection()"]');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            console.log(`üöÄ Proceeding with selection for ${currentProfile.username} - Posts: ${posts}, Highlights: ${highlights}`);
            
            const urls = {
                both: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/a49a9a92-3daa-4916-b5cd-796dd840cc80',
                posts: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/3b5c96fe-61c4-4bfd-9655-52bdccc6a41b',
                highlights: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/732f1aab-c467-41d0-b79d-a1283ffc8b2f'
            };
            
            let url, data;
            
            if (posts && highlights) {
                url = urls.both;
                data = {
                    postsInput: {
                        posts: {
                            "username": currentProfile.username,
                            "resultsLimit": currentProfile.postsCount || 0
                        }
                    },
                    highlightsInput: {
                        highlights: {
                            "profiles": [
                                `https://www.instagram.com/${currentProfile.username}`,
                                currentProfile.username
                            ]
                        }
                    }
                };
            } else if (posts) {
                url = urls.posts;
                data = {
                    postsData: {
                        "username": [currentProfile.username],
                        "resultsLimit": currentProfile.postsCount || 0
                    }
                };
            } else if (highlights) {
                url = urls.highlights;
                data = {
                    input: {
                        "profiles": [
                            `https://www.instagram.com/${currentProfile.username}`,
                            currentProfile.username
                        ]
                    }
                };
            }
            
            try {
                console.log(`üì§ Sending data to: ${url}`, data);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    if (posts && !highlights) {
                        btn.textContent = 'Processing...';
                        await displayPostsResults();
                    } else {
                        alert('‚úÖ Done! Your data has been successfully processed.');
                    }
                } else throw new Error(`HTTP error! status: ${response.status}`);
                
            } catch (error) {
                console.error('Error:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Proceed';
            }
        }

        async function displayPostsResults() {
            const totalPosts = currentProfile.postsCount || 10;
            const totalDuration = totalPosts * 2 * 1000;
            
            console.log(`üé¨ Starting posts results display for ${currentProfile.username} - ${totalPosts} posts, ${totalDuration}ms duration`);
            
            document.getElementById('selectionPage').classList.add('hidden');
            document.getElementById('mainPage').style.display = 'block';
            
            let progress = 0;
            const startTime = Date.now();
            
            document.getElementById('dataDisplay').innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-5 text-center">
                    <div class="text-base font-medium text-gray-700 mb-3">Processing Posts Analysis for @${currentProfile.username}</div>
                    <div class="text-sm text-gray-600 mb-2">Analyzing ${totalPosts.toLocaleString()} posts</div>
                    
                    <div class="w-full max-w-md bg-gray-200 rounded-full h-5 my-5 overflow-hidden shadow-inner">
                        <div class="h-full bg-gradient-to-r from-instagram-pink to-instagram-purple rounded-full transition-all duration-300 relative overflow-hidden shimmer-effect" 
                             id="progressBar" style="width: 0%;"></div>
                    </div>
                    
                    <div class="flex justify-between w-full max-w-md text-xs text-gray-500 mt-3">
                        <span id="progressPercent">0%</span>
                        <span id="progressTime">Estimated time: ${Math.ceil(totalDuration/1000)}s</span>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-600">
                        Please wait while n8n processes your Instagram posts...
                    </div>
                </div>
            `;
            
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressTime = document.getElementById('progressTime');
            
            const updateProgress = () => {
                const elapsed = Date.now() - startTime;
                progress = Math.min((elapsed / totalDuration) * 100, 100);
                
                progressBar.style.width = progress + '%';
                progressPercent.textContent = Math.floor(progress) + '%';
                
                const remainingTime = Math.max(0, Math.ceil((totalDuration - elapsed) / 1000));
                progressTime.textContent = remainingTime > 0 ? `${remainingTime}s remaining` : 'Finalizing...';
                
                if (progress < 100) {
                    requestAnimationFrame(updateProgress);
                }
            };
            
            updateProgress();
            
            setTimeout(async () => {
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressTime.textContent = 'Fetching results...';
                
                setTimeout(async () => {
                    await fetchPostsData();
                }, 1000);
                
            }, totalDuration);
        }

        async function fetchPostsData(retryCount = 0) {
            if (retryCount > 10) {
                document.getElementById('dataDisplay').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-5 mt-5 text-center">
                        <h3 class="text-red-600 text-lg font-bold mb-4">‚ùå Analysis Complete - No Data Found</h3>
                        <p class="text-red-600 mb-4">The analysis process completed, but no results were found for @${currentUsername}.</p>
                        <p class="text-gray-500 text-sm mb-4">
                            This could happen if the Instagram account is private, has no posts, or if there was an issue with the data processing.
                        </p>
                        <div class="space-x-3">
                            <button onclick="resetApp()" class="bg-gray-500 text-white border-none py-2 px-5 rounded cursor-pointer">üîÑ Try Another Profile</button>
                            <button onclick="fetchPostsData(0)" class="bg-instagram-pink text-white border-none py-2 px-5 rounded cursor-pointer">üîÑ Check Again</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            try {
                console.log(`üîÑ Fetching posts data (attempt ${retryCount + 1}/10) for: ${currentUsername}`);
                
                const response = await fetch(`https://testing-n8n-project-production.up.railway.app/api/received-posts?username=${encodeURIComponent(currentUsername)}`);
                
                if (response.ok) {
                    const jsonData = await response.json();
                    console.log(`üìä Received ${jsonData.length} posts items for ${currentUsername}:`, jsonData);
                    
                    const userPostsData = jsonData.find(item => isPostsDataForCurrentUser(item));
                    
                    if (userPostsData) {
                        console.log(`‚úÖ Found valid posts data for ${currentUsername}`);
                        
                        document.getElementById('dataDisplay').innerHTML = `
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 mt-5">
                                <h3 class="text-instagram-pink text-lg font-bold mb-4">üìä Posts Analysis Results for @${currentProfile.username}</h3>
                                <div class="bg-white p-4 rounded-lg mb-4">
                                    <strong>Analysis completed!</strong><br>
                                    <small class="text-gray-600">Data received at: ${userPostsData.receivedAt || 'Unknown'}</small>
                                </div>
                                <pre class="bg-white p-4 rounded-lg overflow-x-auto text-xs leading-relaxed max-h-96 overflow-y-auto border border-gray-200">${JSON.stringify(userPostsData, null, 2)}</pre>
                                <button onclick="resetApp()" class="bg-gray-500 text-white border-none py-2 px-5 rounded mt-4 cursor-pointer">üîÑ Analyze Another Profile</button>
                            </div>
                        `;
                        
                        alert('‚úÖ Posts analysis completed! Results displayed below.');
                        return;
                    }
                }
                
                console.log(`‚è≥ No posts data yet for ${currentUsername}, retrying in 3s...`);
                setTimeout(() => fetchPostsData(retryCount + 1), 3000);
                
            } catch (error) {
                console.error('Error fetching posts results:', error);
                setTimeout(() => fetchPostsData(retryCount + 1), 5000);
            }
        }

        function resetApp() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('selectionPage').classList.add('hidden');
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('usernameInput').value = '';
            currentProfile = null;
            currentUsername = '';
            console.log('üîÑ App reset');
        }
        
        document.getElementById('usernameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') startAnalysis();
        });
    </script>
</body>
</html>
