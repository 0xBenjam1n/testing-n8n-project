<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Simple Form</h1>
        
        <form id="simpleForm" class="space-y-4">
            <div>
                <label for="userInput" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter your message
                </label>
                <input 
                    type="text" 
                    id="userInput" 
                    name="userInput"
                    placeholder="Type something here..."
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    required
                >
            </div>
            
            <button 
                type="submit" 
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 font-medium"
            >
                Submit
            </button>
        </form>
        
        <div id="result" class="mt-6 p-4 rounded-md hidden">
            <p id="resultMessage"></p>
        </div>
        
        <div id="n8nResult" class="mt-6 p-4 rounded-md hidden">
            <h3 class="font-semibold mb-2">Processing Result:</h3>
            <div id="n8nResultContent"></div>
            
            <!-- Confirmation section -->
            <div id="confirmationSection" class="mt-4 p-4 bg-blue-50 rounded-lg border hidden">
                <div class="flex items-center space-x-2 mb-3">
                    <input type="checkbox" id="confirmOwnership" class="w-4 h-4 text-blue-600 rounded">
                    <label for="confirmOwnership" class="text-sm font-medium text-gray-700">
                        Yes, this is my page
                    </label>
                </div>
                <button 
                    id="confirmButton" 
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
                    disabled
                >
                    Confirm
                </button>
            </div>
        </div>
        
        <!-- Second page for processing options -->
        <div id="processingPage" class="mt-6 p-4 rounded-md bg-gray-50 border hidden">
            <h3 class="font-semibold mb-4 text-lg">Select Processing Options:</h3>
            
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="processPosts" class="w-4 h-4 text-blue-600 rounded">
                    <label for="processPosts" class="text-sm font-medium text-gray-700">
                        Posts
                    </label>
                </div>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="processHighlights" class="w-4 h-4 text-blue-600 rounded">
                    <label for="processHighlights" class="text-sm font-medium text-gray-700">
                        Highlights
                    </label>
                </div>
            </div>
            
            <button 
                id="processButton" 
                class="mt-4 w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
                disabled
            >
                Process
            </button>
        </div>
        
        <!-- Processing result display -->
        <div id="processingResult" class="mt-6 p-4 rounded-md hidden">
            <h3 class="font-semibold mb-2">Processing Complete:</h3>
            <div id="processingResultContent"></div>
        </div>
        
        <div id="processingLoading" class="mt-6 text-center hidden">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
            <p class="text-gray-600 mt-2" id="processingLoadingText">Processing...</p>
        </div>
        
        <div id="loading" class="mt-6 text-center hidden">
            <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <p class="text-gray-600 mt-2" id="loadingText">Sending...</p>
        </div>
    </div>

    <script>
        'use strict';
        
        // Global variables
        var pollInterval = null;
        var pollAttempts = 0;
        var lastRequestTime = 0;
        var storedInstagramData = null;
        var processingPollInterval = null;
        var processingPollAttempts = 0;
        
        // Constants
        var MAX_POLL_ATTEMPTS = 60;
        var POLL_INTERVAL_MS = 5000;
        var RATE_LIMIT_MS = 2000;
        
        // Generate unique request ID
        function generateRequestId() {
            return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }
        
        // HTML escaping
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Input sanitization
        function sanitizeInput(input) {
            return input
                .trim()
                .replace(/[<>]/g, '')
                .replace(/javascript:/gi, '')
                .replace(/data:/gi, '')
                .replace(/vbscript:/gi, '')
                .replace(/on\w+\s*=/gi, '');
        }
        
        // Input validation
        function validateInput(input) {
            if (!input || input.length === 0) {
                return { valid: false, message: 'Input cannot be empty' };
            }
            if (input.length > 500) {
                return { valid: false, message: 'Input too long (max 500 characters)' };
            }
            
            var suspiciousPatterns = [
                /<script[^>]*>.*?<\/script>/gi,
                /javascript:/gi,
                /data:/gi,
                /vbscript:/gi,
                /on\w+\s*=/gi,
                /expression\s*\(/gi,
                /url\s*\(/gi,
                /@import/gi,
                /\/\*.*?\*\//g
            ];
            
            for (var i = 0; i < suspiciousPatterns.length; i++) {
                if (suspiciousPatterns[i].test(input)) {
                    return { valid: false, message: 'Invalid content detected' };
                }
            }
            return { valid: true };
        }
        
        // Rate limiting
        function checkRateLimit() {
            var now = Date.now();
            if (now - lastRequestTime < RATE_LIMIT_MS) {
                return { allowed: false, message: 'Please wait before sending another message' };
            }
            lastRequestTime = now;
            return { allowed: true };
        }
        
        // Update loading text
        function updateLoadingText(text) {
            var loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        function updateProcessingLoadingText(text) {
            var loadingText = document.getElementById('processingLoadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }
        
        // Start polling for processing results
        function startProcessingPolling(requestId) {
            processingPollAttempts = 0;
            
            if (processingPollInterval) {
                clearInterval(processingPollInterval);
            }
            
            processingPollInterval = setInterval(function() {
                processingPollAttempts++;
                
                fetch('/poll-result/' + requestId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'omit'
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 202) {
                        updateProcessingLoadingText('Processing... (' + processingPollAttempts + '/' + MAX_POLL_ATTEMPTS + ')');
                        return null;
                    } else {
                        throw new Error('Polling failed');
                    }
                })
                .then(function(data) {
                    if (data && data.success && data.data) {
                        clearInterval(processingPollInterval);
                        showProcessingResult(data.data);
                        showProcessingLoading(false);
                    }
                    
                    if (processingPollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(processingPollInterval);
                        showProcessingError('Processing timeout. Please try again.');
                        showProcessingLoading(false);
                    }
                })
                .catch(function(error) {
                    console.error('Processing polling error:', error);
                    processingPollAttempts++;
                    
                    if (processingPollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(processingPollInterval);
                        showProcessingError('Failed to get processing result. Please try again.');
                        showProcessingLoading(false);
                    }
                });
            }, POLL_INTERVAL_MS);
        }
        
        // Stop processing polling
        function stopProcessingPolling() {
            if (processingPollInterval) {
                clearInterval(processingPollInterval);
                processingPollInterval = null;
            }
        }
        
        // Show processing result
        function showProcessingResult(data) {
            var processingResult = document.getElementById('processingResult');
            var processingResultContent = document.getElementById('processingResultContent');
            
            processingResultContent.innerHTML = '';
            
            var resultDiv = document.createElement('div');
            resultDiv.className = 'space-y-2';
            
            // Status
            if (data.status) {
                var statusDiv = document.createElement('div');
                var statusLabel = document.createElement('span');
                statusLabel.className = 'font-medium text-gray-700';
                statusLabel.textContent = 'Status: ';
                var statusValue = document.createElement('span');
                statusValue.className = data.status === 'success' ? 'text-green-600' : 'text-red-600';
                statusValue.textContent = data.status;
                statusDiv.appendChild(statusLabel);
                statusDiv.appendChild(statusValue);
                resultDiv.appendChild(statusDiv);
            }
            
            // Result
            if (data.result) {
                var resultTextDiv = document.createElement('div');
                var resultLabel = document.createElement('div');
                resultLabel.className = 'font-medium text-gray-700';
                resultLabel.textContent = 'Processing Result:';
                var resultContent = document.createElement('div');
                resultContent.className = 'bg-gray-50 p-3 rounded border mt-1 max-h-60 overflow-y-auto';
                resultContent.style.fontSize = '12px';
                resultContent.style.fontFamily = 'monospace';
                resultContent.textContent = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
                resultTextDiv.appendChild(resultLabel);
                resultTextDiv.appendChild(resultContent);
                resultDiv.appendChild(resultTextDiv);
            }
            
            // Message
            if (data.message && data.message !== 'No message provided') {
                var messageDiv = document.createElement('div');
                var messageLabel = document.createElement('span');
                messageLabel.className = 'font-medium text-gray-700';
                messageLabel.textContent = 'Message: ';
                var messageValue = document.createElement('span');
                messageValue.textContent = data.message;
                messageDiv.appendChild(messageLabel);
                messageDiv.appendChild(messageValue);
                resultDiv.appendChild(messageDiv);
            }
            
            // Timestamp
            if (data.timestamp) {
                var timeDiv = document.createElement('div');
                timeDiv.className = 'text-sm text-gray-500';
                timeDiv.textContent = 'Completed at: ' + new Date(data.timestamp).toLocaleString();
                resultDiv.appendChild(timeDiv);
            }
            
            processingResultContent.appendChild(resultDiv);
            processingResult.classList.remove('hidden');
            processingResult.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show processing error
        function showProcessingError(message) {
            var processingResult = document.getElementById('processingResult');
            var processingResultContent = document.getElementById('processingResultContent');
            
            processingResultContent.innerHTML = '';
            
            var errorDiv = document.createElement('div');
            errorDiv.className = 'p-3 bg-red-100 text-red-700 rounded border';
            errorDiv.textContent = message;
            
            processingResultContent.appendChild(errorDiv);
            processingResult.classList.remove('hidden');
            processingResult.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show/hide processing loading
        function showProcessingLoading(show) {
            var loading = document.getElementById('processingLoading');
            var processButton = document.getElementById('processButton');
            
            if (show) {
                loading.classList.remove('hidden');
                processButton.disabled = true;
                processButton.textContent = 'Processing...';
                processButton.className = processButton.className.replace('bg-purple-600 hover:bg-purple-700', 'bg-gray-400 cursor-not-allowed');
                updateProcessingLoadingText('Processing...');
            } else {
                loading.classList.add('hidden');
                processButton.disabled = false;
                processButton.textContent = 'Process';
                processButton.className = processButton.className.replace('bg-gray-400 cursor-not-allowed', 'bg-purple-600 hover:bg-purple-700');
                updateProcessButton(); // Re-check if button should be enabled
            }
        }
        
        // Start polling for results
        function startPolling(requestId) {
            pollAttempts = 0;
            
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            pollInterval = setInterval(function() {
                pollAttempts++;
                
                fetch('/poll-result/' + requestId, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'omit'
                })
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 202) {
                        updateLoadingText('Waiting for processing... (' + pollAttempts + '/' + MAX_POLL_ATTEMPTS + ')');
                        return null;
                    } else {
                        throw new Error('Polling failed');
                    }
                })
                .then(function(data) {
                    if (data && data.success && data.data) {
                        clearInterval(pollInterval);
                        showN8nResult(data.data);
                        showLoading(false);
                    }
                    
                    if (pollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(pollInterval);
                        showResult('Processing timeout. The result may still arrive later.', false);
                        showLoading(false);
                    }
                })
                .catch(function(error) {
                    console.error('Polling error:', error);
                    pollAttempts++;
                    
                    if (pollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(pollInterval);
                        showResult('Failed to get processing result. Please try again.', false);
                        showLoading(false);
                    }
                });
            }, POLL_INTERVAL_MS);
        }
        
        // Stop polling
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
        
        // Show n8n result
        function showN8nResult(data) {
            var n8nResult = document.getElementById('n8nResult');
            var n8nResultContent = document.getElementById('n8nResultContent');
            var confirmationSection = document.getElementById('confirmationSection');
            
            // Store the Instagram data for later use
            storedInstagramData = data;
            
            n8nResultContent.innerHTML = '';
            
            var resultDiv = document.createElement('div');
            resultDiv.className = 'space-y-2';
            
            // Status
            if (data.status) {
                var statusDiv = document.createElement('div');
                var statusLabel = document.createElement('span');
                statusLabel.className = 'font-medium text-gray-700';
                statusLabel.textContent = 'Status: ';
                var statusValue = document.createElement('span');
                statusValue.className = data.status === 'success' ? 'text-green-600' : 'text-red-600';
                statusValue.textContent = data.status;
                statusDiv.appendChild(statusLabel);
                statusDiv.appendChild(statusValue);
                resultDiv.appendChild(statusDiv);
            }
            
            // Result
            if (data.result) {
                var resultTextDiv = document.createElement('div');
                var resultLabel = document.createElement('div');
                resultLabel.className = 'font-medium text-gray-700';
                resultLabel.textContent = 'Result:';
                var resultContent = document.createElement('div');
                resultContent.className = 'bg-gray-50 p-3 rounded border mt-1 max-h-60 overflow-y-auto';
                resultContent.style.fontSize = '12px';
                resultContent.style.fontFamily = 'monospace';
                resultContent.textContent = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
                resultTextDiv.appendChild(resultLabel);
                resultTextDiv.appendChild(resultContent);
                resultDiv.appendChild(resultTextDiv);
            }
            
            // Message
            if (data.message && data.message !== 'No message provided') {
                var messageDiv = document.createElement('div');
                var messageLabel = document.createElement('span');
                messageLabel.className = 'font-medium text-gray-700';
                messageLabel.textContent = 'Message: ';
                var messageValue = document.createElement('span');
                messageValue.textContent = data.message;
                messageDiv.appendChild(messageLabel);
                messageDiv.appendChild(messageValue);
                resultDiv.appendChild(messageDiv);
            }
            
            // Timestamp
            if (data.timestamp) {
                var timeDiv = document.createElement('div');
                timeDiv.className = 'text-sm text-gray-500';
                timeDiv.textContent = 'Processed at: ' + new Date(data.timestamp).toLocaleString();
                resultDiv.appendChild(timeDiv);
            }
            
            n8nResultContent.appendChild(resultDiv);
            n8nResult.classList.remove('hidden');
            
            // Show confirmation section only if status is success
            if (data.status === 'success') {
                confirmationSection.classList.remove('hidden');
            }
            
            n8nResult.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Show result message
        function showResult(message, isSuccess) {
            var result = document.getElementById('result');
            var resultMessage = document.getElementById('resultMessage');
            
            result.className = 'mt-6 p-4 rounded-md ' + (isSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
            
            var strongElement = document.createElement('strong');
            strongElement.textContent = isSuccess ? 'Success: ' : 'Error: ';
            
            resultMessage.innerHTML = '';
            resultMessage.appendChild(strongElement);
            resultMessage.appendChild(document.createTextNode(message));
            
            result.classList.remove('hidden');
        }
        
        // Show/hide loading
        function showLoading(show) {
            var loading = document.getElementById('loading');
            var submitBtn = document.querySelector('button[type="submit"]');
            
            if (show) {
                loading.classList.remove('hidden');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Sending...';
                submitBtn.className = submitBtn.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-gray-400 cursor-not-allowed');
                updateLoadingText('Sending...');
            } else {
                loading.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
                submitBtn.className = submitBtn.className.replace('bg-gray-400 cursor-not-allowed', 'bg-blue-600 hover:bg-blue-700');
            }
        }
        
        // Form submission
        document.getElementById('simpleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var input = document.getElementById('userInput');
            var rawValue = input.value;
            
            // Hide previous results
            document.getElementById('result').classList.add('hidden');
            document.getElementById('n8nResult').classList.add('hidden');
            
            // Stop any ongoing polling
            stopPolling();
            
            // Check rate limiting
            var rateLimitCheck = checkRateLimit();
            if (!rateLimitCheck.allowed) {
                showResult(rateLimitCheck.message, false);
                return;
            }
            
            // Validate input
            var validation = validateInput(rawValue);
            if (!validation.valid) {
                showResult(validation.message, false);
                return;
            }
            
            // Sanitize input
            var sanitizedValue = sanitizeInput(rawValue);
            var requestId = generateRequestId();
            
            // Show loading
            showLoading(true);
            
            var webhookUrl = 'https://oxbenjam1n.app.n8n.cloud/webhook-test/ee95c5d8-139e-4d35-8eab-b431b741f563';
            
            var payload = {
                requestId: requestId,
                message: sanitizedValue,
                timestamp: new Date().toISOString(),
                clientInfo: {
                    platform: navigator.platform.substring(0, 20),
                    language: navigator.language
                }
            };
            
            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Client-Type': 'form-submission'
                },
                body: JSON.stringify(payload),
                credentials: 'omit'
            })
            .then(function(response) {
                if (response.ok) {
                    showResult('Message sent successfully! Waiting for processing...', true);
                    input.value = '';
                    updateLoadingText('Waiting for processing...');
                    startPolling(requestId);
                } else if (response.status === 429) {
                    showResult('Too many requests. Please try again later.', false);
                    showLoading(false);
                } else if (response.status >= 400 && response.status < 500) {
                    showResult('Request rejected. Please check your input.', false);
                    showLoading(false);
                } else {
                    showResult('Server temporarily unavailable. Please try again later.', false);
                    showLoading(false);
                }
            })
            .catch(function(error) {
                console.error('Webhook error:', error.message);
                
                if (error.name === 'AbortError') {
                    showResult('Request timed out. Please try again.', false);
                } else {
                    showResult('Network error. Please check your connection.', false);
                }
                
                showLoading(false);
            });
        });
        
        // Handle confirmation checkbox
        document.getElementById('confirmOwnership').addEventListener('change', function() {
            var confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = !this.checked;
        });
        
        // Handle confirm button click
        document.getElementById('confirmButton').addEventListener('click', function() {
            document.getElementById('n8nResult').classList.add('hidden');
            document.getElementById('processingPage').classList.remove('hidden');
            document.getElementById('processingPage').scrollIntoView({ behavior: 'smooth' });
        });
        
        // Handle processing options checkboxes
        function updateProcessButton() {
            var postsChecked = document.getElementById('processPosts').checked;
            var highlightsChecked = document.getElementById('processHighlights').checked;
            var processButton = document.getElementById('processButton');
            
            processButton.disabled = !(postsChecked || highlightsChecked);
        }
        
        document.getElementById('processPosts').addEventListener('change', updateProcessButton);
        document.getElementById('processHighlights').addEventListener('change', updateProcessButton);
        
        // Handle process button click
        document.getElementById('processButton').addEventListener('click', function() {
            var postsChecked = document.getElementById('processPosts').checked;
            var highlightsChecked = document.getElementById('processHighlights').checked;
            
            // Hide previous processing results
            document.getElementById('processingResult').classList.add('hidden');
            
            // Stop any ongoing processing polling
            stopProcessingPolling();
            
            // Get data from stored Instagram response
            var username = '';
            var postsCount = 0;
            var highlightsCount = 0;
            
            if (storedInstagramData && storedInstagramData.result) {
                try {
                    var instagramData = typeof storedInstagramData.result === 'string' ? JSON.parse(storedInstagramData.result) : storedInstagramData.result;
                    username = instagramData.username || '';
                    postsCount = instagramData.postsCount || 0;
                    highlightsCount = instagramData.highlightReelCount || 0;
                } catch (e) {
                    console.error('Error parsing stored data:', e);
                }
            }
            
            // Generate new request ID for processing
            var newRequestId = generateRequestId();
            
            var payload = {
                username: username,
                bothSelected: postsChecked && highlightsChecked,
                posts: postsChecked,
                highlights: highlightsChecked,
                timestamp: new Date().toISOString(),
                requestId: newRequestId,
                resultLimit: postsCount,
                highlightsCount: highlightsCount
            };
            
            console.log('Sending processing payload:', payload);
            
            // Show processing loading
            showProcessingLoading(true);
            
            // Send to webhook
            fetch('https://oxbenjam1n.app.n8n.cloud/webhook-test/c3acf6be-e6bd-465d-b415-efabe6e02f86', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(function(response) {
                if (response.ok) {
                    console.log('Processing request sent successfully');
                    // Start polling for processing result
                    updateProcessingLoadingText('Waiting for processing result...');
                    startProcessingPolling(newRequestId);
                } else if (response.status === 429) {
                    showProcessingError('Too many requests. Please try again later.');
                    showProcessingLoading(false);
                } else if (response.status >= 400 && response.status < 500) {
                    showProcessingError('Request rejected. Please check your input.');
                    showProcessingLoading(false);
                } else {
                    showProcessingError('Server temporarily unavailable. Please try again later.');
                    showProcessingLoading(false);
                }
            })
            .catch(function(error) {
                console.error('Processing request error:', error);
                
                if (error.name === 'AbortError') {
                    showProcessingError('Request timed out. Please try again.');
                } else {
                    showProcessingError('Network error. Please check your connection.');
                }
                
                showProcessingLoading(false);
            });
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            var input = document.getElementById('userInput');
            if (input) input.value = '';
            stopPolling();
            stopProcessingPolling();
        });
    </script>
</body>
</html>
