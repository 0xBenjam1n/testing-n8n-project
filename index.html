<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Profile Analyzer - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'instagram': '#e1306c',
                        'instagram-dark': '#c13584'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            width: 24px; height: 24px; 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #e1306c;
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        .loading-spinner-profile {
            width: 20px; height: 20px; 
            border: 2px solid white; 
            border-top: 2px solid transparent;
            border-radius: 50%; 
            animation: spin 1s linear infinite;
        }
        .profile-pic { transition: opacity 0.3s; }
        .option-item:hover { background: #f3f4f6; border-color: #d1d5db; }
        .option-item.selected {
            background: #fef2f2;
            border-color: #e1306c;
            box-shadow: 0 0 0 2px rgba(225, 48, 108, 0.1);
        }
    </style>
</head>
<body class="font-sans bg-gray-100 p-5">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg">
        <div class="bg-gradient-to-br from-instagram to-instagram-dark text-white p-8 text-center rounded-t-lg">
            <h1 class="text-2xl font-bold mb-2">üì∏ Instagram Analyzer Demo</h1>
            <p>Simple Instagram profile analysis tool</p>
        </div>
        
        <div class="p-8">
            <div id="mainPage">
                <div class="mb-5">
                    <label for="usernameInput" class="block mb-2 font-bold">Instagram Username:</label>
                    <input type="text" id="usernameInput" placeholder="Enter username (e.g., cristiano)" 
                           class="w-full p-3 border-2 border-gray-300 rounded focus:outline-none focus:border-instagram text-base" autocomplete="off">
                </div>
                
                <button class="w-full bg-instagram hover:bg-instagram-dark disabled:bg-gray-400 disabled:cursor-not-allowed text-white p-3 rounded cursor-pointer text-base transition-colors duration-200" 
                        id="analyzeBtn" onclick="startAnalysis()">üîç Analyze Profile</button>
                <div id="status" class="hidden mt-4 p-3 rounded-md text-center text-sm font-medium"></div>
                
                <div class="mt-8 pt-5 border-t-2 border-gray-100 hidden" id="resultsSection">
                    <h2 class="text-lg mb-4 text-gray-800">üìä Analysis Results</h2>
                    <div id="dataDisplay"></div>
                </div>
            </div>

            <div id="selectionPage" class="hidden">
                <h2 class="text-lg mb-4 text-gray-800">üìã Content Selection</h2>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 my-5">
                    <p class="mb-5 text-gray-500 text-center">
                        Select what content you want to analyze:
                    </p>
                    
                    <div class="grid gap-4 my-5">
                        <div class="option-item bg-gray-50 border-2 border-gray-200 rounded-lg p-4 flex items-center gap-3 transition-all cursor-pointer select-none" 
                             onclick="toggleOption('posts')">
                            <input type="checkbox" id="postsCheck" class="w-5 h-5 cursor-pointer pointer-events-none" style="accent-color: #e1306c;">
                            <div class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-700 mb-1">üì∏ Posts</div>
                                <div class="text-sm text-gray-500" id="postsCount">0 posts available</div>
                            </div>
                        </div>
                        
                        <div class="option-item bg-gray-50 border-2 border-gray-200 rounded-lg p-4 flex items-center gap-3 transition-all cursor-pointer select-none" 
                             onclick="toggleOption('highlights')">
                            <input type="checkbox" id="highlightsCheck" class="w-5 h-5 cursor-pointer pointer-events-none" style="accent-color: #e1306c;">
                            <div class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-700 mb-1">‚ú® Highlights</div>
                                <div class="text-sm text-gray-500" id="highlightsCount">0 highlights available</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-center gap-3 mt-5">
                        <button class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 border-0 rounded-md cursor-pointer text-sm" onclick="goBack()">‚Üê Back</button>
                        <button class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white px-5 py-2 border-0 rounded-md cursor-pointer text-sm" 
                                onclick="proceedWithSelection()" disabled>Proceed</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUsername = '', currentProfile = null;
        
        class UniversalImageLoader {
            static cache = new Map();
            
            static async loadImage(imageUrl, container) {
                if (!imageUrl) return this.showFallback(container);
                
                if (this.cache.has(imageUrl)) {
                    const result = this.cache.get(imageUrl);
                    return result.success ? this.showImage(container, result.url) : this.showFallback(container);
                }
                
                this.showLoading(container);
                
                try {
                    await this.loadDirectImage(imageUrl, container);
                } catch {
                    try {
                        await this.loadWithProxy(imageUrl, container);
                    } catch {
                        this.cache.set(imageUrl, { success: false });
                        this.showFallback(container);
                    }
                }
            }
            
            static loadDirectImage(imageUrl, container) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        this.cache.set(imageUrl, { success: true, url: imageUrl });
                        this.showImage(container, imageUrl);
                        resolve();
                    };
                    img.onerror = () => reject();
                    img.crossOrigin = 'anonymous';
                    img.src = imageUrl;
                    setTimeout(reject, 5000);
                });
            }
            
            static async loadWithProxy(imageUrl, container) {
                const proxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`,
                    `https://cors-anywhere.herokuapp.com/${imageUrl}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(imageUrl)}`,
                    imageUrl
                ];

                for (const proxy of proxies) {
                    try {
                        const response = await fetch(proxy, { headers: { 'Accept': 'image/*' } });
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            this.cache.set(imageUrl, { success: true, url });
                            this.showImage(container, url);
                            return;
                        }
                    } catch { continue; }
                }
                throw new Error('All proxies failed');
            }
            
            static showLoading(container) {
                container.innerHTML = '<div class="loading-spinner-profile"></div>';
            }
            
            static showImage(container, src) {
                container.innerHTML = `<img src="${src}" alt="Profile Picture" class="profile-pic w-full h-full rounded-full border-4 border-white object-cover" crossorigin="anonymous" onload="this.style.opacity='1'" onerror="this.parentElement.innerHTML='<div class=&quot;w-full h-full rounded-full border-4 border-white bg-gray-600 flex items-center justify-center text-2xl text-white&quot;>üë§</div>'" style="opacity:0; transition: opacity 0.3s;">`;
            }
            
            static showFallback(container) {
                const colors = ['#e53e3e', '#3182ce', '#38a169', '#d69e2e', '#805ad5', '#d53f8c'];
                container.innerHTML = `<div class="w-full h-full rounded-full border-4 border-white flex items-center justify-center text-2xl text-white" style="background-color: ${colors[Math.floor(Math.random() * colors.length)]};">üë§</div>`;
            }
        }
        
        function toggleOption(type) {
            const checkbox = document.getElementById(type + 'Check');
            const item = checkbox.closest('.option-item');
            checkbox.checked = !checkbox.checked;
            item.classList.toggle('selected', checkbox.checked);
            updateProceedButton();
        }
        
        function updateProceedButton() {
            const posts = document.getElementById('postsCheck').checked;
            const highlights = document.getElementById('highlightsCheck').checked;
            document.querySelector('[onclick="proceedWithSelection()"]').disabled = !posts && !highlights;
        }
        
        async function startAnalysis() {
            const input = document.getElementById('usernameInput');
            const button = document.getElementById('analyzeBtn');
            const username = input.value.trim();
            
            if (!username) return showStatus('Please enter an Instagram username', 'error');
            
            // Clear all stored data when analysis starts
            try {
                await fetch('https://testing-n8n-project-production.up.railway.app/api/clear-data', {
                    method: 'DELETE'
                });
                console.log('üóëÔ∏è Cleared all stored data before starting new analysis');
            } catch (error) {
                console.log('Could not clear stored data:', error);
            }
            
            currentUsername = username;
            button.disabled = true;
            button.textContent = 'üîÑ Analyzing...';
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('dataDisplay').innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-5 text-center">
                    <div class="loading-spinner"></div>
                    <div class="text-base font-medium text-gray-800 mt-4">Analyzing @${username}</div>
                    <div class="text-sm text-gray-500 mt-2">Please wait while we fetch the profile data...</div>
                </div>`;
            
            try {
                const response = await fetch('https://oxbenjam1n.app.n8n.cloud/webhook-test/ee95c5d8-139e-4d35-8eab-b431b741f563', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ run_input: JSON.stringify({ usernames: [username] }) })
                });
                
                if (response.ok) {
                    input.value = '';
                    setTimeout(checkForResults, 3000);
                } else throw new Error(`HTTP error! status: ${response.status}`);
                
            } catch (error) {
                console.error('Network error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                document.getElementById('resultsSection').classList.add('hidden');
            } finally {
                button.disabled = false;
                button.textContent = 'üîç Analyze Profile';
            }
        }
        
        async function checkForResults(retryCount = 0) {
            if (retryCount > 30) { // Increased retry count for longer waiting
                document.getElementById('dataDisplay').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <h3 class="text-red-600 text-lg font-semibold mb-3">‚è∞ Timeout</h3>
                        <p class="text-red-600 mb-3">No data received after waiting. This might happen if:</p>
                        <ul class="text-red-600 text-sm mb-4 text-left list-disc list-inside">
                            <li>The Instagram username doesn't exist</li>
                            <li>The profile is private and can't be analyzed</li>
                            <li>n8n is taking longer than expected</li>
                            <li>There was a network issue</li>
                        </ul>
                        <div class="space-x-2">
                            <button onclick="resetApp()" class="bg-gray-500 text-white px-5 py-2 rounded-md mr-2 cursor-pointer hover:bg-gray-600">üîÑ Try Another Profile</button>
                            <button onclick="checkForResults(0)" class="bg-instagram text-white px-5 py-2 rounded-md cursor-pointer hover:bg-instagram-dark">üîÑ Check Again</button>
                        </div>
                    </div>`;
                return;
            }
            
            try {
                const response = await fetch('https://testing-n8n-project-production.up.railway.app/api/received-data');
                const data = await response.json();
                
                // Check if we have data and if it's recent (within last 10 minutes) or contains our username
                if (data.length > 0 && data[0].userInformation) {
                    const latestData = data[0];
                    const isRecent = latestData.receivedAt && new Date(latestData.receivedAt) > new Date(Date.now() - 10*60*1000);
                    const containsUsername = JSON.stringify(latestData).toLowerCase().includes(currentUsername.toLowerCase());
                    
                    if (isRecent || containsUsername) {
                        displayProfile(latestData.userInformation);
                        return;
                    }
                }
                
                // Update loading message without retry count
                document.getElementById('dataDisplay').innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 px-5 text-center">
                        <div class="loading-spinner"></div>
                        <div class="text-base font-medium text-gray-800 mt-4">Analyzing @${currentUsername}</div>
                        <div class="text-sm text-gray-500 mt-2">This may take a few seconds...</div>
                    </div>`;
                
                setTimeout(() => checkForResults(retryCount + 1), 5000); // Check every 5 seconds
                
            } catch (error) {
                console.error('Error checking for results:', error);
                setTimeout(() => checkForResults(retryCount + 1), 5000);
            }
        }
        
        function displayProfile(profile) {
            currentProfile = profile;
            const format = (num) => (num || 0).toLocaleString();
            const badge = (val, text) => `<span class="inline-block px-2 py-1 rounded-full text-xs font-bold ${val ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">${val ? 'Yes' : 'No'}</span>`;
            
            document.getElementById('dataDisplay').innerHTML = `
                <div class="bg-gradient-to-br from-instagram to-instagram-dark text-white p-8 rounded-xl mb-5 text-center">
                    <div class="w-24 h-24 mx-auto mb-5 rounded-full flex items-center justify-center" id="profilePicContainer"></div>
                    <div class="text-xl font-bold mb-2">${profile.fullName || 'No name provided'}</div>
                    <div class="text-base opacity-90 mb-5">@${profile.username}</div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-5">
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.followersCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block tracking-wide">Followers</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.followsCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block tracking-wide">Following</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${format(profile.postsCount)}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block tracking-wide">Posts</span>
                        </div>
                        <div class="text-center bg-white bg-opacity-10 p-3 rounded-lg">
                            <span class="block text-lg font-bold">${profile.verified ? '‚úÖ' : '‚ùå'}</span>
                            <span class="text-xs opacity-80 uppercase mt-1 block tracking-wide">Verified</span>
                        </div>
                    </div>
                    
                    ${profile.biography ? `<div class="bg-white bg-opacity-10 p-4 rounded-lg mt-4 text-left leading-relaxed"><strong>Bio:</strong><br>${profile.biography}</div>` : ''}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <h3 class="text-base font-semibold text-instagram mb-4 pb-2 border-b-2 border-gray-100">üìä Account Details</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">Account Type:</span>
                                <span class="text-gray-800 text-right">${profile.isBusinessAccount ? 'Business' : 'Personal'}</span>
                            </div>
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">Private:</span>
                                <span class="text-right">${badge(profile.private)}</span>
                            </div>
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">Verified:</span>
                                <span class="text-right">${badge(profile.verified)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border border-gray-200 rounded-lg p-5">
                        <h3 class="text-base font-semibold text-instagram mb-4 pb-2 border-b-2 border-gray-100">üì∫ Content Stats</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">Highlights:</span>
                                <span class="text-gray-800 text-right">${profile.highlightReelCount || 0}</span>
                            </div>
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">IGTV Videos:</span>
                                <span class="text-gray-800 text-right">${profile.igtvVideoCount || 0}</span>
                            </div>
                            <div class="flex justify-between items-center py-1">
                                <span class="font-bold text-gray-600">Has Channel:</span>
                                <span class="text-right">${badge(profile.hasChannel)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 my-6 text-center">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <input type="checkbox" id="ownershipCheck" class="w-5 h-5 cursor-pointer" style="accent-color: #e1306c;">
                        <label for="ownershipCheck" class="cursor-pointer font-medium text-gray-700 text-base">Yes, this is my page</label>
                    </div>
                    <button class="w-full bg-instagram hover:bg-instagram-dark text-white p-3 rounded-md font-semibold cursor-pointer transition-colors" onclick="confirmOwnership()">Confirm</button>
                </div>`;
            
            UniversalImageLoader.loadImage(profile.profilePicUrlHD || profile.profilePicUrl, document.getElementById('profilePicContainer'));
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `mt-4 p-3 rounded-md text-center text-sm font-medium ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
            status.classList.remove('hidden');
            if (type === 'success') setTimeout(() => status.classList.add('hidden'), 5000);
        }
        
        function confirmOwnership() {
            if (!document.getElementById('ownershipCheck').checked) {
                return alert('Please check the confirmation box first!');
            }
            showSelectionPage();
        }

        function showSelectionPage() {
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('selectionPage').classList.remove('hidden');
            
            document.getElementById('postsCount').textContent = `${(currentProfile?.postsCount || 0).toLocaleString()} posts available`;
            document.getElementById('highlightsCount').textContent = `${(currentProfile?.highlightReelCount || 0).toLocaleString()} highlights available`;
            
            ['postsCheck', 'highlightsCheck'].forEach(id => document.getElementById(id).checked = false);
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
            updateProceedButton();
        }

        function goBack() {
            document.getElementById('selectionPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            ['postsCheck', 'highlightsCheck'].forEach(id => document.getElementById(id).checked = false);
            document.querySelectorAll('.option-item').forEach(item => item.classList.remove('selected'));
        }

        async function proceedWithSelection() {
            const posts = document.getElementById('postsCheck').checked;
            const highlights = document.getElementById('highlightsCheck').checked;
            const btn = document.querySelector('[onclick="proceedWithSelection()"]');
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            const urls = {
                both: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/a49a9a92-3daa-4916-b5cd-796dd840cc80',
                posts: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/3b5c96fe-61c4-4bfd-9655-52bdccc6a41b',
                highlights: 'https://oxbenjam1n.app.n8n.cloud/webhook-test/732f1aab-c467-41d0-b79d-a1283ffc8b2f'
            };
            
            let url, data;
            
            if (posts && highlights) {
                url = urls.both;
                data = {
                    postsInput: {
                        posts: {
                            "username": currentProfile.username,
                            "resultsLimit": currentProfile.postsCount || 0
                        }
                    },
                    highlightsInput: {
                        highlights: {
                            "profiles": [
                                `https://www.instagram.com/${currentProfile.username}`,
                                currentProfile.username
                            ]
                        }
                    }
                };
            } else if (posts) {
                url = urls.posts;
                data = {
                    postsData: {
                        "username": [currentProfile.username],
                        "resultsLimit": currentProfile.postsCount || 0
                    }
                };
            } else if (highlights) {
                url = urls.highlights;
                data = {
                    input: {
                        "profiles": [
                            `https://www.instagram.com/${currentProfile.username}`,
                            currentProfile.username
                        ]
                    }
                };
            }
            
            try {
                // Clear old data before sending new request
                await fetch('https://testing-n8n-project-production.up.railway.app/api/clear-data', {
                    method: 'DELETE'
                }).catch(() => {});
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    if (posts && !highlights) {
                        btn.textContent = 'Processing...';
                        await displayPostsResults();
                    } else {
                        alert('‚úÖ Done! Your data has been successfully processed.');
                    }
                } else throw new Error(`HTTP error! status: ${response.status}`);
                
            } catch (error) {
                console.error('Error:', error);
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Proceed';
            }
        }

        async function displayPostsResults() {
            let attempts = 0;
            const maxAttempts = 40; // Increased for longer waiting
            
            document.getElementById('selectionPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            
            // Show progress bar for posts analysis
            document.getElementById('dataDisplay').innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 px-5 text-center">
                    <div class="text-base font-medium text-gray-800 mb-6">Processing Posts Analysis for @${currentProfile.username}</div>
                    <div class="w-full max-w-md">
                        <div class="bg-gray-200 rounded-full h-3 mb-4">
                            <div class="bg-gradient-to-r from-instagram to-instagram-dark h-3 rounded-full transition-all duration-1000 ease-out" 
                                 id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="text-sm text-gray-500">This may take a few seconds...</div>
                    </div>
                </div>
            `;
            
            // Animate progress bar smoothly
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 3; // Random increment for realistic feel
                if (progress > 90) progress = 90; // Don't complete until we get data
                document.getElementById('progressBar').style.width = progress + '%';
            }, 200);
            
            const pollForResults = async () => {
                try {
                    attempts++;
                    console.log(`Polling attempt ${attempts}/${maxAttempts} for posts results...`);
                    
                    const response = await fetch('https://testing-n8n-project-production.up.railway.app/api/received-posts');
                    
                    if (response.ok) {
                        const jsonData = await response.json();
                        console.log('Received posts data:', jsonData);
                        
                        if (jsonData && Array.isArray(jsonData) && jsonData.length > 0) {
                            const recentData = jsonData[0];
                            
                            if (recentData && (
                                JSON.stringify(recentData).toLowerCase().includes(currentProfile.username.toLowerCase()) ||
                                (recentData.receivedAt && new Date(recentData.receivedAt) > new Date(Date.now() - 10*60*1000))
                            )) {
                                // Complete progress bar and display JSON data
                                clearInterval(progressInterval);
                                document.getElementById('progressBar').style.width = '100%';
                                
                                // Display the raw JSON data like before
                                setTimeout(() => {
                                    document.getElementById('dataDisplay').innerHTML = `
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 mt-5">
                                            <h3 class="text-instagram text-lg font-semibold mb-4">üìä Posts Analysis Results for @${currentProfile.username}</h3>
                                            <div class="bg-white p-4 rounded-md mb-4">
                                                <strong>Data received at:</strong> ${recentData.receivedAt || 'Unknown'}
                                            </div>
                                            <pre class="bg-white p-4 rounded-md overflow-x-auto text-xs leading-relaxed max-h-96 overflow-y-auto border font-mono">${JSON.stringify(recentData, null, 2)}</pre>
                                            <button onclick="resetApp()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-md mt-4 cursor-pointer transition-colors">üîÑ Analyze Another Profile</button>
                                        </div>
                                    `;
                                }, 500); // Small delay to show completed progress
                                
                                alert('‚úÖ Posts analysis completed! Results displayed below.');
                                return;
                            }
                        }
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(pollForResults, 5000);
                    } else {
                        clearInterval(progressInterval);
                        throw new Error('Timeout: No data received after maximum attempts. Please try again.');
                    }
                    
                } catch (error) {
                    clearInterval(progressInterval);
                    if (attempts < maxAttempts && !error.message.includes('Timeout')) {
                        console.log(`Network error on attempt ${attempts}, retrying...`);
                        setTimeout(pollForResults, 5000);
                    } else {
                        console.error('Error fetching posts results:', error);
                        document.getElementById('dataDisplay').innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-lg p-5 mt-5 text-center">
                                <h3 class="text-red-600 text-lg font-semibold mb-4">‚ùå Error</h3>
                                <p class="text-red-600 mb-4">Failed to fetch results: ${error.message}</p>
                                <p class="text-gray-500 text-sm mb-4">
                                    This could happen if n8n is taking longer than expected or if there was a network issue.
                                </p>
                                <div class="space-x-2">
                                    <button onclick="resetApp()" class="bg-gray-500 hover:bg-gray-600 text-white px-5 py-2 rounded-md cursor-pointer transition-colors">üîÑ Try Another Profile</button>
                                    <button onclick="displayPostsResults()" class="bg-instagram hover:bg-instagram-dark text-white px-5 py-2 rounded-md cursor-pointer transition-colors">üîÑ Check Again</button>
                                </div>
                            </div>
                        `;
                    }
                }
            };
            
            // Start polling after a 10-second delay to give n8n time to process
            setTimeout(pollForResults, 10000);
        }

        // Function to reset the app
        function resetApp() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('usernameInput').value = '';
            currentProfile = null;
            currentUsername = '';
        }
        
        document.getElementById('usernameInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') startAnalysis();
        });
    </script>
</body>
</html>
